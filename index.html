<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>BB Tengaged ‚Äî Modular Enhanced Build</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<link rel="icon" type="image/png" href="icons/icon-192.png"/>
<link rel="apple-touch-icon" href="icons/icon-192.png"/>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;800&family=Oswald:wght@600;700&display=swap" rel="stylesheet">

  <!-- After fonts in <head> -->
<link rel="stylesheet" href="styles.css?v=fixes-5">
<link rel="stylesheet" href="mobile_Version3.css?v=fixes-5">
<link rel="stylesheet" href="overrides-fixes.css?v=fixes-5">
</head>
<body>
<!-- Top Controls -->
<div class="topbar">
  <button class="btn" id="btnOpenSettings">‚öôÔ∏è Settings</button>
  <button class="btn" id="btnStartQuick">‚ñ∂ Start</button>

  <!-- Optional buttons controlled by the app -->
  <button class="btn" id="btnAdvancePhase" style="display:none;">‚û° Advance</button>
  <button class="btn" id="btnMusicToggle" style="display:none">üéµ Music</button>
</div>

<div class="wrap">
  <!-- Dashboard (left) ‚Äî Cast completely removed -->
  <div class="card" id="dashboardCard">
    <h1>Dashboard</h1>
    <div class="row tiny wrapline">
      <div>Phase: <span id="phase" class="pill">lobby</span></div>
      <div>Week: <span id="week" class="badge">1</span></div>
      <div>HOH: <span id="hoh" class="badge warn">none</span></div>
      <div>Noms: <span id="noms" class="badge">‚Äì</span></div>
      <div>Veto: <span id="veto" class="badge">‚Äì</span></div>
      <div>Alive: <span id="alive" class="badge ok">0</span></div>
      <div><span id="statusBadge" class="badge">lobby</span></div>
      <div id="doubleBadge" class="badge bad" style="display:none;">DOUBLE</div>
      <div id="tripleBadge" class="badge bad" style="display:none;">TRIPLE</div>
      <div id="manualBadge" class="badge acc" style="display:none;">MANUAL</div>
      <div id="juryHouseBadge" class="badge" style="display:none;">JURY</div>
      <div id="openingBadge" class="badge" style="display:none;">OPENING</div>
    </div>
    <div class="sep"></div>
    <h2 id="timerHeading" data-fixed="timer">Timer</h2>
    <div class="row baseline">
      <span class="tiny muted">Remaining</span>
      <span id="countdown" class="timeReading">00:00</span>
      <!-- Only one Skip will be kept here by the script below -->
    </div>
    <div class="progressbar"><div id="tvProgressFill" class="progressbar-fill"></div></div>
    <!-- Cast header, table, and note intentionally removed -->
  </div>

  <!-- Show / Center -->
  <div class="card" id="actionCard">
    <h1>Show</h1>
    <div class="tv" id="tv">
      <div class="tvHead">
        <div class="tvTitle">House Network Live</div>
        <div class="tvTimer" id="tvTimer">00:00</div>
      </div>
      <div id="tvNow" class="tvNow">Welcome to the season.</div>
      <div id="tvOverlay" class="tvOverlay"></div>
      <canvas id="confetti"></canvas>
    </div>
    <div class="sep"></div>
    <div id="panel"></div>
  </div>

  <!-- Right: Logs (with Jury) + Jury House -->
  <div class="card" id="sideCard">
    <h1>Logs</h1>
    <div id="logTabs" class="tabBar">
      <button class="tab-btn active" data-logtab="all">All</button>
      <button class="tab-btn" data-logtab="game">Game</button>
      <button class="tab-btn" data-logtab="social">Social</button>
      <button class="tab-btn" data-logtab="vote">Vote</button>
      <button class="tab-btn" data-logtab="jury">Jury</button>
    </div>
    <div id="logPanes">
      <div id="log" class="log log-pane active" data-pane="all"></div>
      <div id="logGame" class="log log-pane" data-pane="game"></div>
      <div id="logSocial" class="log log-pane" data-pane="social"></div>
      <div id="logVote" class="log log-pane" data-pane="vote"></div>
      <div id="logJury" class="log log-pane" data-pane="jury"></div>
    </div>

    <div class="sep"></div>

    <div id="juryHousePanel" style="display:none;">
      <h1>Jury House</h1>
      <div class="tiny muted" id="juryHouseStatus">Inactive.</div>
      <div class="sep"></div>
      <h2>Jurors</h2>
      <div id="juryRoster" class="tiny muted">None yet.</div>
      <div class="sep"></div>
      <h2>Jury Log</h2>
      <div id="juryLog" class="jury-log"></div>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="modal-backdrop" aria-modal="true" role="dialog">
  <div class="modal">
    <button class="closeX" id="btnCloseSettings">‚úï</button>
    <h2>Settings</h2>
    <div class="modalTabs">
      <button class="tab-btn active" data-tab="tabTimers">Room & Timers</button>
      <button class="tab-btn" data-tab="tabFeatures">Features</button>
      <button class="tab-btn" data-tab="tabTwists">Twists</button>
      <button class="tab-btn" data-tab="tabManage">Manage</button>
    </div>
    <div class="settingsTabPane active" id="tabTimers">
      <h3>Room & Timers</h3>
      <div class="settingsGrid">
        <label>Human name<input id="humanName" value="You"/></label>
        <label>Players total<input id="numPlayers" type="number" min="6" max="22" value="12"/></label>
        <label>TV Background Image URL<input id="tvBgUrl" type="url" placeholder="https://...image.jpg"/></label>
        <label>HOH seconds<input id="tHOH" type="number" min="10" value="35"/></label>
        <label>Noms seconds<input id="tNoms" type="number" min="10" value="25"/></label>
        <label>Veto seconds<input id="tVeto" type="number" min="10" value="30"/></label>
        <label>Veto decision<input id="tVetoDec" type="number" min="10" value="20"/></label>
        <label>Comms seconds<input id="tComms" type="number" min="10" value="30"/></label>
        <label>Live vote seconds<input id="tVote" type="number" min="10" value="25"/></label>
        <label>Jury seconds<input id="tJury" type="number" min="10" value="42"/></label>
        <label>Juror return vote seconds<input id="tJuryReturnVote" type="number" min="8" value="12"/></label>
      </div>
    </div>
    <div class="settingsTabPane" id="tabFeatures">
      <h3>Features</h3>
      <div class="toggleRow">
        <label class="inline"><input id="fxCards" type="checkbox" checked/> Reveal cards</label>
        <label class="inline"><input id="fxSound" type="checkbox" checked/> Sound FX</label>
        <label class="inline"><input id="fxAnim" type="checkbox" checked/> Extra animations</label>
        <label class="inline"><input id="manualMode" type="checkbox"/> Manual mode</label>
        <label class="inline"><input id="enableJuryHouse" type="checkbox" checked/> Jury house</label>
        <label class="inline"><input id="autoMusicSetting" type="checkbox" checked/> Auto music</label>
        <label class="inline">Card style:
          <select id="fxStyle">
            <option value="fade">Fade</option>
            <option value="slide">Slide</option>
            <option value="flip">Flip</option>
            <option value="zoom">Zoom</option>
          </select>
        </label>
        <label class="inline">Minigames:
          <select id="miniMode">
            <option value="random">Random</option>
            <option value="clicker">Clicker only</option>
            <option value="cycle">Cycle</option>
          </select>
        </label>
      </div>
    </div>
    <div class="settingsTabPane" id="tabTwists">
      <h3>Twists</h3>
      <div class="toggleRow">
        <label class="inline">Double eviction % <input id="doubleChance" type="number" min="0" max="100" value="10" style="max-width:80px"/></label>
        <label class="inline">Triple eviction % <input id="tripleChance" type="number" min="0" max="100" value="3" style="max-width:80px"/></label>
        <label class="inline">Return twist % <input id="returnChance" type="number" min="1" max="100" value="50" style="max-width:80px"/></label>
        <label class="inline">Auto-eviction % <input id="selfEvictChance" type="number" min="0" max="2" step="0.1" value="0" style="max-width:80px"/></label>
      </div>
      <div class="tiny muted">Juror return can trigger before HOH when enough jurors are in the Jury House.</div>
    </div>
    <div class="settingsTabPane" id="tabManage">
      <h3>Cast Edit (Lobby Only)</h3>
      <div class="row">
        <button id="btnEditCast" class="btn small">Toggle Edit Mode</button>
        <button id="btnRebuildGame" class="btn small">Rebuild Game</button>
      </div>
      <div class="sep"></div>
      <h3>Game Control</h3>
      <div class="row">
        <button id="btnStart" class="btn primary small">Restart Season</button>
        <button id="btnReset" class="btn danger small">Reset to default</button>
      </div>
      <div class="sep"></div>
      <h3>Data</h3>
      <div class="row">
        <button id="btnExport2" class="btn small">Export Save</button>
        <button id="btnImport2" class="btn small">Import Save</button>
      </div>
      <div class="tiny muted" style="margin-top:6px">Esc or ‚úï closes and auto‚Äësaves.</div>
    </div>
  </div>
</div>

<!-- Finale Overlay -->
<div id="finaleDim">
  <div class="winnerBanner" id="finalWinnerBanner">WINNER</div>
  <div class="winnerName" id="finalWinnerName">Name</div>
  <div class="actions" id="finaleActions">
    <button class="btn small" id="btnFinalReset">Hard Reset</button>
    <button class="btn small" id="btnFinalReplay">Replay Cast</button>
  </div>
</div>

<audio id="bgm" preload="auto" loop></audio>

<!-- SCRIPT LOAD ORDER -->
<script src="js/state.js"></script>
<script>window.MUSIC_BASE = 'audio/';</script> <script src="js/audio.js?v=fixes-6"></script>

<!-- Settings & UI -->
<script defer src="js/ui.config-and-settings.js"></script>

<!-- NEW: TV screen upload (image/video) -->
<script defer src="js/ui.tv-media.js"></script>
<script defer src="js/settings.js"></script>
<script defer src="js/players-total.js?v=5"></script>
<script defer src="js/ui.overlay-and-logs.js"></script>
<script defer src="js/ui.hud-and-router.js"></script>

<script defer src="js/ui.rules.js?v=fixes-5"></script>
<script defer src="js/rules.js"></script>

<!-- Game flows -->
<script src="js/social.js"></script>
<script src="js/minigames.js"></script>
<script src="js/competitions.js"></script>
<script src="js/nominations.js"></script>
<script src="js/veto.js"></script>
<script src="js/eviction.js"></script>
<script src="js/jury.js"></script>
<script defer src="js/jury-viz.js?v=2"></script>

<!-- Juror return (America vote) -->
<script src="js/jury_return_vote.js"></script>

<script src="js/twists.js"></script>
<script src="js/persistence.js"></script>
<script src="js/bootstrap.js"></script>
<script src="js/integrity.js"></script>
<script src="js/finale.js"></script>
  
<script defer src="js/intro-outro-video.js?v=fixes-5"></script>

<script defer src="js/logs-helper.js?v=fixes-5"></script>
<script defer src="https://www.youtube.com/iframe_api"></script>

<!-- Custom intro/outro video hooks (must load after end-credits) -->
<script defer src="js/intro-outro-video.js?v=4"></script>

<!-- Single Skip + roster placement hover (no external deps) -->
<script>
(function(){
  // Hide any Skip inside the TV; keep at most one Skip in the timer row
  function keepSingleSkip(){
    document.querySelectorAll('#tv button, #tv .btn').forEach(el=>{
      if (/^\\s*skip\\s*$/i.test(el.textContent||'')) el.style.display = 'none';
    });
    const base = document.querySelector('#dashboardCard .row.baseline');
    if (!base) return;
    const skips = Array.from(base.querySelectorAll('button, .btn'))
      .filter(el => /^\\s*skip\\s*$/i.test(el.textContent||''));
    if (skips.length > 1) skips.slice(1).forEach(el => el.remove());
  }

  // Hover: Winner/Runner-up/12th... on top roster tiles
  function placementsHover(){
    const ord = n => { n=+n; const s=["th","st","nd","rd"], v=n%100; return n+(s[(v-20)%10]||s[v]||s[0]); };
    const getEvictWeek = p => p?.evictWeek ?? p?.evictedWeek ?? p?.weekEvicted ?? p?.evictionWeek ?? p?.evict_wk ?? null;
    const isWinner   = p => !!(p.winner||p.isWinner||p.finalPlace===1||p.place===1||p.rank===1);
    const isRunnerUp = p => !!(p.runnerUp||p.isRunnerUp||p.finalPlace===2||p.place===2||p.rank===2);
    const nameOf = p => (p?.name||p?.Name||p?.displayName||'').trim().toLowerCase();

    function computePlacements(){
      const players = (window.game?.players || window.players || []).slice();
      if (!players.length) return new Map();
      const total = players.length;
      const ev = players
        .filter(p => !!(p.evicted || p.state==='evicted' || getEvictWeek(p)!=null))
        .sort((a,b)=>{ const aw=getEvictWeek(a), bw=getEvictWeek(b);
          if (aw!=null&&bw!=null) return aw-bw; if (aw!=null) return -1; if (bw!=null) return 1; return 0; });
      const m = new Map();
      ev.forEach((p,i)=> m.set(nameOf(p), ord(total - i)));
      players.forEach(p=>{ const nm=nameOf(p); if (!nm) return;
        if (isWinner(p)) m.set(nm,'Winner'); else if (isRunnerUp(p)) m.set(nm,'Runner-up'); });
      return m;
    }

    function apply(){
      const map = computePlacements();
      document.querySelectorAll('.top-roster-tile').forEach(tile=>{
        const nm = (tile.querySelector('.top-tile-name')?.textContent||'').trim().toLowerCase();
        const label = map.get(nm);
        if (label){ tile.title = label; tile.dataset.placeLabel = label; }
      });
    }

    const host = document.querySelector('.top-roster-row') || document.getElementById('panel') || document.getElementById('actionCard');
    if (!host){ setTimeout(placementsHover, 400); return; }
    apply();
    const mo = new MutationObserver(apply);
    mo.observe(host, { childList:true, subtree:true, characterData:true });
    window.addEventListener('bb:eviction', apply, { passive:true });
    window.addEventListener('bb:winner', apply, { passive:true });
  }

  // Add Rules button between Settings and Start
  function ensureRulesButton(){
    const topbar = document.querySelector('.topbar');
    if(!topbar) return;
    
    // Check if Rules button already exists
    if(document.getElementById('btnRules')) return;
    
    const settingsBtn = document.getElementById('btnOpenSettings');
    const startBtn = document.getElementById('btnStartQuick');
    if(!settingsBtn || !startBtn) return;
    
    const rulesBtn = document.createElement('button');
    rulesBtn.id = 'btnRules';
    rulesBtn.className = 'btn';
    rulesBtn.textContent = 'üìã Rules';
    
    rulesBtn.onclick = ()=>{
      // Use the new showRulesModal function from rules.js
      if(typeof window.showRulesModal === 'function'){
        window.showRulesModal();
      }
    };
    
    // Insert after Settings button
    settingsBtn.parentNode.insertBefore(rulesBtn, startBtn);
  }

  function init(){ keepSingleSkip(); placementsHover(); ensureRulesButton(); }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init, { once:true });
  else init();
})();
</script>

</body>
</html>
