<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>BB Tengaged ‚Äî Modular Enhanced Build</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<link rel="icon" type="image/png" href="icons/icon-192.png"/>
<link rel="apple-touch-icon" href="icons/icon-192.png"/>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;800&family=Oswald:wght@600;700&display=swap" rel="stylesheet">

  <!-- After fonts in <head> -->
<link rel="stylesheet" href="styles.css?v=fixes-5">
<link rel="stylesheet" href="overrides-fixes.css?v=fixes-5">

<!-- Global shim for resilience against stray global references -->
<script>window.global = window;</script>
</head>
<body>
<!-- Top Controls -->
<div class="topbar">
  <button class="btn" id="btnOpenSettings">‚öôÔ∏è Settings</button>
  <button class="btn" id="btnStartQuick">‚ñ∂ Start</button>

  <!-- Optional buttons controlled by the app -->
  <button class="btn" id="btnAdvancePhase" style="display:none;">‚û° Advance</button>
  <button class="btn" id="btnMusicToggle" style="display:none">üéµ Music</button>
  <button class="btn" id="btnMuteToggle" aria-pressed="false" title="Toggle sound">üîä</button>
  <!-- XP/Leaderboard Badge Button -->
  <button class="btn" id="xpLeaderboardBadge" title="View Score & Level" aria-label="Open leaderboard">
    üìä XP
  </button>
</div>

<div class="wrap">
  <!-- Dashboard (left) ‚Äî Cast completely removed -->
  <div class="card" id="dashboardCard">
    <!-- REDESIGNED DASHBOARD: Title moved to timer section below -->
    
    <!-- Row 1: HOH / POV -->
    <div class="dashboard-row">
      <div class="dashboard-info-item">
        <span class="dashboard-label">HOH</span>
        <span id="hoh" class="dashboard-badge dashboard-badge-hoh">none</span>
      </div>
      <div class="dashboard-info-item">
        <span class="dashboard-label">POV</span>
        <span id="veto" class="dashboard-badge dashboard-badge-pov">‚Äì</span>
      </div>
    </div>
    
    <!-- Row 2: Nominees -->
    <div class="dashboard-row">
      <div class="dashboard-info-item dashboard-info-full">
        <span class="dashboard-label">Nominees</span>
        <div id="noms" class="dashboard-nominees">‚Äì</div>
      </div>
    </div>
    
    <!-- Row 3: Alive / Evicted -->
    <div class="dashboard-row">
      <div class="dashboard-info-item">
        <span class="dashboard-label">Alive</span>
        <span id="alive" class="dashboard-badge dashboard-badge-alive">0</span>
      </div>
      <div class="dashboard-info-item">
        <span class="dashboard-label">Evicted</span>
        <span id="evicted" class="dashboard-badge dashboard-badge-evicted">0</span>
      </div>
    </div>
    
    <!-- Special badges (double, triple, etc.) -->
    <div class="dashboard-special-badges">
      <span id="doubleBadge" class="badge bad" style="display:none;">DOUBLE</span>
      <span id="tripleBadge" class="badge bad" style="display:none;">TRIPLE</span>
      <span id="manualBadge" class="badge acc" style="display:none;">MANUAL</span>
      <span id="juryHouseBadge" class="badge" style="display:none;">JURY</span>
      <span id="openingBadge" class="badge" style="display:none;">OPENING</span>
    </div>
    
    <div class="sep"></div>
    
    <!-- Timer Section with Hourglass -->
    <div class="dashboard-timer-section" role="region" aria-label="Phase timer and status">
      <!-- Compact header row: Week + Phase -->
      <div class="dashboard-timer-compact-header" aria-label="Current game status">
        <span id="timerWeekBadge" class="timer-week-badge" aria-label="Current week">Week 1</span>
        <span id="timerPhaseName" class="timer-phase-name">Season Premiere</span>
      </div>
      
      <!-- Two-column layout: left (time/timer/skip stacked), right (hourglass) -->
      <div class="dashboard-timer-content">
        <div class="timer-left-column">
          <span class="dashboard-timer-label" id="timerLabel">TIME:</span>
          <span id="countdown" class="dashboard-timer-display" aria-live="polite" aria-atomic="true" aria-labelledby="timerLabel">00:00</span>
          <!-- Skip button will be positioned here by script -->
          <div id="timerSkipContainer" class="timer-skip-container" role="group" aria-label="Timer controls"></div>
        </div>
        
        <div class="timer-right-column">
          <!-- HOURGLASS TIMER -->
          <div class="hourglass-container" aria-hidden="true">
            <svg class="hourglass-svg" viewBox="0 0 100 140" xmlns="http://www.w3.org/2000/svg">
              <defs>
                <linearGradient id="glassGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" style="stop-color:#4695ff;stop-opacity:0.3" />
                  <stop offset="100%" style="stop-color:#71bfff;stop-opacity:0.5" />
                </linearGradient>
                <linearGradient id="sandGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                  <stop offset="0%" style="stop-color:#ffdc8b;stop-opacity:1" />
                  <stop offset="100%" style="stop-color:#ff9f4a;stop-opacity:1" />
                </linearGradient>
              </defs>
              <path class="hourglass-frame" d="M 20,10 L 80,10 L 80,15 Q 80,20 75,25 L 55,45 Q 50,50 50,50 Q 50,50 45,45 L 25,25 Q 20,20 20,15 Z M 20,130 L 80,130 L 80,125 Q 80,120 75,115 L 55,95 Q 50,90 50,90 Q 50,90 45,95 L 25,115 Q 20,120 20,125 Z" 
                    fill="url(#glassGradient)" stroke="#4695ff" stroke-width="2" opacity="0.4"/>
              <clipPath id="hourglassClip">
                <path d="M 22,12 L 78,12 L 78,15 Q 78,19 74,23 L 54,43 Q 50,47 50,50 Q 50,53 54,57 L 74,77 Q 78,81 78,85 L 78,128 L 22,128 L 22,85 Q 22,81 26,77 L 46,57 Q 50,53 50,50 Q 50,47 46,43 L 26,23 Q 22,19 22,15 Z"/>
              </clipPath>
              <g clip-path="url(#hourglassClip)">
                <rect id="hourglassSandTop" class="hourglass-sand-top" x="22" y="12" width="56" height="0" fill="url(#sandGradient)"/>
              </g>
              <g clip-path="url(#hourglassClip)">
                <rect id="hourglassSandBottom" class="hourglass-sand-bottom" x="22" y="88" width="56" height="0" fill="url(#sandGradient)"/>
              </g>
              <circle id="hourglassSandFlow" class="hourglass-sand-flow" cx="50" cy="50" r="2" fill="#ffdc8b" opacity="0"/>
            </svg>
          </div>
        </div>
      </div>
    </div>
    <!-- Cast header, table, and note intentionally removed -->
  </div>

  <!-- Show / Center -->
  <div class="card" id="actionCard">
    <h1>Houseguests</h1>
    <!-- Roster Bar (above TV) -->
    <div id="rosterBar"></div>
    <div class="tvFrame">
      <div class="tvBezel">
        <div class="tv" id="tv">
          <div class="tvHead">
            <div class="tvTitle">House Network Live</div>
            <div class="tvTimer" id="tvTimer">00:00</div>
          </div>
          <div class="tvViewport">
            <div id="tvNow" class="tvNow">Welcome to the season.</div>
            <div id="tvOverlay" class="tvOverlay"></div>
            <canvas id="confetti"></canvas>
            <!-- Live badge for voting phases (INSIDE viewport) -->
            <div class="liveBadge" id="liveBadge" aria-live="polite" aria-label="Live voting in progress" style="display:none;">LIVE</div>
          </div>
        </div>
      </div>
    </div>
    <div class="sep"></div>
    <div id="panel"></div>
  </div>

  <!-- Right: Logs (with Jury) + Jury House -->
  <div class="card" id="sideCard">
    <h1>Diary Room</h1>
    <div id="logTabs" class="tabBar">
      <button class="tab-btn active" data-logtab="all">All</button>
      <button class="tab-btn" data-logtab="game">Game</button>
      <button class="tab-btn" data-logtab="social">Social</button>
      <button class="tab-btn" data-logtab="vote">Vote</button>
      <button class="tab-btn" data-logtab="jury">Jury</button>
    </div>
    <div id="logPanes">
      <div id="log" class="log log-pane active" data-pane="all"></div>
      <div id="logGame" class="log log-pane" data-pane="game"></div>
      <div id="logSocial" class="log log-pane" data-pane="social"></div>
      <div id="logVote" class="log log-pane" data-pane="vote"></div>
      <div id="logJury" class="log log-pane" data-pane="jury"></div>
    </div>

    <div class="sep"></div>

    <div id="juryHousePanel" style="display:none;">
      <h1>Jury House</h1>
      <div class="tiny muted" id="juryHouseStatus">Inactive.</div>
      <div class="sep"></div>
      <h2>Jurors</h2>
      <div id="juryRoster" class="tiny muted">None yet.</div>
      <div class="sep"></div>
      <h2>Jury Log</h2>
      <div id="juryLog" class="jury-log"></div>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="modal-backdrop" aria-modal="true" role="dialog">
  <div class="modal">
    <button class="closeX" id="btnCloseSettings">‚úï</button>
    <h2>Settings</h2>
    <div class="modalTabs">
      <button class="tab-btn active" data-tab="tabTimers">Room & Timers</button>
      <button class="tab-btn" data-tab="tabFeatures">Features</button>
      <button class="tab-btn" data-tab="tabTwists">Twists</button>
      <button class="tab-btn" data-tab="tabManage">Manage</button>
    </div>
    <div class="settingsTabPane active" id="tabTimers">
      <h3>Room & Timers</h3>
      <div class="settingsGrid">
        <label>Human name<input id="humanName" value="You"/></label>
        <label>Players total<input id="numPlayers" type="number" min="6" max="22" value="12"/></label>
        <label>TV Background Image URL<input id="tvBgUrl" type="url" placeholder="https://...image.jpg"/></label>
        <label>HOH seconds<input id="tHOH" type="number" min="10" value="35"/></label>
        <label>Noms seconds<input id="tNoms" type="number" min="10" value="25"/></label>
        <label>Veto seconds<input id="tVeto" type="number" min="10" value="30"/></label>
        <label>Veto decision<input id="tVetoDec" type="number" min="10" value="20"/></label>
        <label>Comms seconds<input id="tComms" type="number" min="10" value="30"/></label>
        <label>Live vote seconds<input id="tVote" type="number" min="10" value="25"/></label>
        <label>Jury seconds<input id="tJury" type="number" min="10" value="42"/></label>
        <label>Juror return vote seconds<input id="tJuryReturnVote" type="number" min="8" value="12"/></label>
      </div>
    </div>
    <div class="settingsTabPane" id="tabFeatures">
      <h3>Features</h3>
      <div class="toggleRow">
        <label class="inline"><input id="fxCards" type="checkbox" checked/> Reveal cards</label>
        <label class="inline"><input id="fxSound" type="checkbox" checked/> Sound FX</label>
        <label class="inline"><input id="fxAnim" type="checkbox" checked/> Extra animations</label>
        <label class="inline"><input id="manualMode" type="checkbox"/> Manual mode</label>
        <label class="inline"><input id="enableJuryHouse" type="checkbox" checked/> Jury house</label>
        <label class="inline"><input id="autoMusicSetting" type="checkbox" checked/> Auto music</label>
        <label class="inline"><input id="enablePublicFav" type="checkbox"/> Public's Favourite Player at finale</label>
        <label class="inline">Card style:
          <select id="fxStyle">
            <option value="fade">Fade</option>
            <option value="slide">Slide</option>
            <option value="flip">Flip</option>
            <option value="zoom">Zoom</option>
          </select>
        </label>
        <label class="inline">Minigames:
          <select id="miniMode">
            <option value="random">Random</option>
            <option value="clicker">Clicker only</option>
            <option value="cycle">Cycle</option>
          </select>
        </label>
        <label class="inline" style="width:100%;flex-basis:100%;">House Theme:
          <select id="themeSelector" style="margin-left:8px;">
            <option value="classic">Classic - Original Big Brother</option>
            <option value="wooden">Wooden House - Cozy Cabin</option>
            <option value="studio">TV Studio - Broadcast Pro</option>
            <option value="modern">Modern House - Sleek Minimalist</option>
          </select>
        </label>
      </div>
      <div class="tiny muted" style="margin-top:6px;">Select a house theme to change colors and atmosphere. Your preference is saved automatically.</div>
    </div>
    <div class="settingsTabPane" id="tabTwists">
      <h3>Twists</h3>
      <div class="toggleRow">
        <label class="inline">Double eviction % <input id="doubleChance" type="number" min="0" max="100" value="10" style="max-width:80px"/></label>
        <label class="inline">Triple eviction % <input id="tripleChance" type="number" min="0" max="100" value="3" style="max-width:80px"/></label>
        <label class="inline">Return twist % <input id="returnChance" type="number" min="1" max="100" value="50" style="max-width:80px"/></label>
        <label class="inline">Auto-eviction % <input id="selfEvictChance" type="number" min="0" max="2" step="0.1" value="0" style="max-width:80px"/></label>
      </div>
      <div class="tiny muted">Juror return can trigger before HOH when enough jurors are in the Jury House.</div>
    </div>
    <div class="settingsTabPane" id="tabManage">
      <h3>Cast Edit (Lobby Only)</h3>
      <div class="row">
        <button id="btnEditCast" class="btn small">Toggle Edit Mode</button>
        <button id="btnRebuildGame" class="btn small">Rebuild Game</button>
      </div>
      <div class="sep"></div>
      <h3>Game Control</h3>
      <div class="row">
        <button id="btnStart" class="btn primary small">Restart Season</button>
        <button id="btnReset" class="btn danger small">Reset to default</button>
      </div>
      <div class="sep"></div>
      <h3>Data</h3>
      <div class="row">
        <button id="btnExport2" class="btn small">Export Save</button>
        <button id="btnImport2" class="btn small">Import Save</button>
      </div>
      <div class="tiny muted" style="margin-top:6px">Esc or ‚úï closes and auto‚Äësaves.</div>
    </div>
  </div>
</div>

<!-- Finale Overlay -->
<div id="finaleDim">
  <div class="winnerBanner" id="finalWinnerBanner">WINNER</div>
  <div class="winnerName" id="finalWinnerName">Name</div>
  <div class="actions" id="finaleActions">
    <button class="btn small" id="btnFinalReset">Hard Reset</button>
    <button class="btn small" id="btnFinalReplay">Replay Cast</button>
  </div>
</div>

<audio id="bgm" preload="auto" loop></audio>

<!-- SCRIPT LOAD ORDER -->
<script src="js/state.js"></script>
<script src="js/avatar.js"></script>
<script>window.MUSIC_BASE = 'audio/';</script> <script src="js/audio.js?v=fixes-6"></script>

<!-- Settings & UI -->
<script defer src="js/ui.config-and-settings.js"></script>
<script defer src="js/theme-switcher.js"></script>

<!-- NEW: TV screen upload (image/video) -->
<script defer src="js/ui.tv-media.js"></script>
<script defer src="js/tv.js"></script>
<script defer src="js/settings.js"></script>
<script defer src="js/players-total.js?v=5"></script>
<script defer src="js/ui.overlay-and-logs.js"></script>
<script defer src="js/cards-queue.js"></script>
<script defer src="js/ui.hud-and-router.js?v=bio-panel-2"></script>

<script defer src="js/ui.rules.js?v=fixes-5"></script>
<script defer src="js/rules.js"></script>
<script defer src="js/player-profile-modal.js"></script>
<script src="js/ui.week-intro.js"></script>
<script src="js/ui.event-modal.js"></script>
<script src="js/ui.confirm-modal.js"></script>

<!-- Game flows -->
<script src="js/social.js"></script>
<script src="js/minigames.js"></script><!-- Legacy stub - see docs/minigames.md -->

<!-- Utilities -->
<script defer src="js/bbGameBus.js"></script>
<script defer src="js/bbSeededRng.js"></script>

<!-- Phase 1: New mobile-first minigames -->
<script defer src="js/minigames/count-house.js"></script>
<script defer src="js/minigames/reaction-royale.js"></script>
<script defer src="js/minigames/trivia-pulse.js"></script>

<!-- Phase 1: Scaffolds -->
<script defer src="js/minigames/oteviator.js"></script>
<script defer src="js/minigames/comix-spot.js"></script>
<script defer src="js/minigames/hold-wall.js"></script>
<script defer src="js/minigames/slippery-shuttle.js"></script>
<script defer src="js/minigames/memory-zipline.js"></script>
<script defer src="js/minigames/social-strings.js"></script>
<script defer src="js/minigames/swipe-maze.js"></script>

<!-- Legacy minigames (migrated to modules) -->
<script defer src="js/minigames/reaction-timer.js"></script>
<script defer src="js/minigames/trivia-quiz.js"></script>
<script defer src="js/minigames/memory-match.js"></script>
<script defer src="js/minigames/slider-puzzle.js"></script>
<script defer src="js/minigames/sequence-memory.js"></script>
<script defer src="js/minigames/math-blitz.js"></script>
<script defer src="js/minigames/timing-bar.js"></script>
<script defer src="js/minigames/pattern-match.js"></script>
<script defer src="js/minigames/word-anagram.js"></script>
<script defer src="js/minigames/target-practice.js"></script>
<script defer src="js/minigames/memory-pairs.js"></script>
<script defer src="js/minigames/estimation-game.js"></script>

<!-- Retired legacy games (available but not preferred) -->
<script defer src="js/minigames/word-typing.js"></script>
<script defer src="js/minigames/path-finder.js"></script>
<script defer src="js/minigames/simon-says.js"></script>

<!-- Additional minigames -->
<script defer src="js/minigames/color-match.js"></script>
<script defer src="js/minigames/tower-stack.js"></script>
<script defer src="js/minigames/guess-number.js"></script>
<script defer src="js/minigames/mini-maze.js"></script>
<script defer src="js/minigames/spot-difference.js"></script>
<script defer src="js/minigames/word-builder.js"></script>
<script defer src="js/minigames/hidden-object.js"></script>
<script defer src="js/minigames/balance-game.js"></script>
  <script defer src="js/minigames/quick-tap.js"></script>

<!-- Phase 0-8: Minigame system (see docs/minigames.md) -->
<script defer src="js/minigames/registry.js"></script><!-- Central metadata store -->
<script defer src="js/minigames/selector.js"></script><!-- Non-repeating pool selection -->
<script defer src="js/minigames/scoring.js"></script><!-- Unified scoring -->
<script defer src="js/minigames/mobile-utils.js"></script><!-- Touch/tap helpers -->
<script defer src="js/minigames/accessibility.js"></script><!-- A11y features -->
<script defer src="js/minigames/telemetry.js"></script><!-- Event logging -->
<script defer src="js/minigames/error-handler.js"></script><!-- Error recovery -->
<script defer src="js/minigames/debug-panel.js"></script><!-- Debug tools -->
<!-- Game enhancements: Win probability & anti-cheat system -->
<script defer src="js/minigames/gameUtils.js"></script><!-- Win probability & utilities -->
<script defer src="js/minigames/GameConfig.js"></script><!-- Game registry -->
<script defer src="js/minigames/components/AntiCheatWrapper.js"></script><!-- Anti-cheat wrapper -->
<script defer src="js/debug/GameSelector.js"></script><!-- Debug game selector -->
<!-- Core extensions (Phases 0-8) -->
<script defer src="js/minigames/core/lifecycle.js"></script><!-- Lifecycle manager -->
<script defer src="js/minigames/core/watchdog.js"></script><!-- Timeout protection -->
<script defer src="js/minigames/core/compat-bridge.js"></script><!-- Legacy key mapping -->
<script defer src="js/minigames/core/context.js"></script><!-- Shared utilities -->
<!-- Stabilization hotfix: key resolver and bootstrap -->
<script defer src="js/minigames/core/key-resolver.js"></script><!-- Key resolution layer -->
<script defer src="js/minigames/core/registry-bootstrap.js"></script><!-- Bootstrap key mappings -->

<!-- E2E Test Harness: Startup audit for registry/selector health -->
<script defer src="startup/minigame-registry-audit.js"></script><!-- Startup validation -->

<!-- Legacy compatibility bridge - maps old keys to new modules -->
<script defer src="js/minigames/index.js"></script>
<script defer src="js/competitions.js"></script>
<script defer src="js/nominations.js"></script>
<script defer src="js/veto.js"></script>
<script defer src="js/eviction.js"></script>
<script defer src="js/jury.js"></script>
<script defer src="js/jury-viz.js?v=2"></script>

<!-- Juror return (America vote) -->
<script src="js/jury_return.js"></script>
<script src="js/jury_return_vote.js"></script>

<script src="js/twists.js"></script>
<script src="js/persistence.js"></script>
<script src="js/player-bio.js"></script>
<script src="js/bootstrap.js"></script>
<script src="js/integrity.js"></script>
<script src="js/finale.js"></script>
  
<script defer src="js/intro-outro-video.js?v=fixes-5"></script>

<script defer src="js/logs-helper.js?v=fixes-5"></script>
<script defer src="js/logs.js"></script>
<script defer src="https://www.youtube.com/iframe_api"></script>


<!-- Comprehensive Enhancement PR Scripts -->
<script defer src="js/results-popup.js"></script>
<script defer src="js/social-narrative.js"></script>

<!-- Debug tools for competition fairness testing -->
<script defer src="js/debug-tools.js"></script>

<!-- Progression System Integration -->
<!-- Load order: bridge first (synchronous module) ‚Üí events and ui (deferred) -->
<script type="module" src="js/progression-bridge.js"></script>
<script defer src="js/progression-events.js"></script>
<script defer src="js/progression-ui.js"></script>

<!-- Single Skip + roster placement hover (no external deps) -->
<script>
(function(){
  // Hide any Skip inside the TV; keep at most one Skip in the timer row
  function keepSingleSkip(){
    document.querySelectorAll('#tv button, #tv .btn').forEach(el=>{
      if (/^\\s*skip\\s*$/i.test(el.textContent||'')) el.style.display = 'none';
    });
    
    // Move skip button to timer skip container
    const timerSkipContainer = document.querySelector('#timerSkipContainer');
    const oldBase = document.querySelector('#dashboardCard .row.baseline');
    
    if (timerSkipContainer) {
      // Find all skip buttons
      let skipBtn = null;
      if(oldBase){
        skipBtn = Array.from(oldBase.querySelectorAll('button, .btn'))
          .find(el => /^\\s*skip\\s*$/i.test(el.textContent||''));
      }
      if(!skipBtn){
        skipBtn = Array.from(document.querySelectorAll('#dashboardCard button, #dashboardCard .btn'))
          .find(el => /^\\s*skip\\s*$/i.test(el.textContent||''));
      }
      
      // Move to timer skip container if found
      if(skipBtn){
        timerSkipContainer.appendChild(skipBtn);
      }
    }
    
    // Update timer header with week and phase
    updateTimerHeader();
  }
  
  // Update timer header with week and phase info
  function updateTimerHeader(){
    const game = window.game || {};
    const weekBadge = document.getElementById('timerWeekBadge');
    const phaseName = document.getElementById('timerPhaseName');
    
    if(weekBadge && phaseName){
      // Determine week text
      let aliveCount = 0;
      try{ aliveCount = (window.alivePlayers?.() || []).length; }catch{}
      
      let weekText = 'House';
      if(game.phase && game.phase !== 'lobby'){
        if(aliveCount <= 2){
          weekText = 'Final Week';
        } else {
          weekText = `Week ${game.week || 1}`;
        }
      }
      weekBadge.textContent = weekText;
      
      // Determine phase name
      let phaseText = '';
      if(game.phase && game.phase !== 'lobby'){
        const phaseNames = {
          'opening': 'Season Premiere',
          'intermission': 'Strategizing',
          'hoh': 'HOH Competition',
          'nominations': 'Nominations',
          'veto_comp': 'Veto Competition',
          'veto': 'Veto Competition',
          'veto_ceremony': 'Veto Ceremony',
          'livevote': 'Eviction',
          'jury': 'Jury Deliberation',
          'return_twist': 'Return Challenge',
          'final3_comp1': 'Final 3 ‚Äì Part 1',
          'final3_comp2': 'Final 3 ‚Äì Part 2',
          'final3_decision': 'Final 3 ‚Äì Decision',
          'social': 'Social Time'
        };
        phaseText = phaseNames[game.phase] || game.phase.replace(/_/g, ' ').replace(/\\b\\w/g, l => l.toUpperCase());
      }
      phaseName.textContent = phaseText;
      phaseName.title = phaseText; // Tooltip for truncated text
    }
    
    // Also update the main dashboard title header
    updateDashboardHeader();
  }
  
  // Update main dashboard title header with week and phase info
  function updateDashboardHeader(){
    const game = window.game || {};
    const weekBadge = document.getElementById('dashboardWeekBadge');
    const phaseName = document.getElementById('dashboardPhaseName');
    
    if(weekBadge && phaseName){
      // Determine week text
      let aliveCount = 0;
      try{ aliveCount = (window.alivePlayers?.() || []).length; }catch{}
      
      let weekText = 'House';
      if(game.phase && game.phase !== 'lobby'){
        if(aliveCount <= 2){
          weekText = 'Final Week';
        } else {
          weekText = `Week ${game.week || 1}`;
        }
      }
      weekBadge.textContent = weekText;
      
      // Determine phase name
      let phaseText = '';
      if(game.phase && game.phase !== 'lobby'){
        const phaseNames = {
          'opening': 'Season Premiere',
          'intermission': 'Strategizing',
          'hoh': 'HOH Competition',
          'nominations': 'Nominations',
          'veto_comp': 'Veto Competition',
          'veto': 'Veto Competition',
          'veto_ceremony': 'Veto Ceremony',
          'livevote': 'Eviction',
          'jury': 'Jury Deliberation',
          'return_twist': 'Return Challenge',
          'final3_comp1': 'Final 3 ‚Äì Part 1',
          'final3_comp2': 'Final 3 ‚Äì Part 2',
          'final3_decision': 'Final 3 ‚Äì Decision',
          'social': 'Social Time'
        };
        phaseText = phaseNames[game.phase] || game.phase.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
      }
      phaseName.textContent = phaseText;
      phaseName.title = phaseText; // Tooltip for truncated text
    }
  }
  
  // Expose to window for external access
  window.updateDashboardHeader = updateDashboardHeader;

  // Hover: Winner/Runner-up/12th... on top roster tiles
  function placementsHover(){
    const ord = n => { n=+n; const s=["th","st","nd","rd"], v=n%100; return n+(s[(v-20)%10]||s[v]||s[0]); };
    const getEvictWeek = p => p?.evictWeek ?? p?.evictedWeek ?? p?.weekEvicted ?? p?.evictionWeek ?? p?.evict_wk ?? null;
    const isWinner   = p => !!(p.winner||p.isWinner||p.finalPlace===1||p.place===1||p.rank===1);
    const isRunnerUp = p => !!(p.runnerUp||p.isRunnerUp||p.finalPlace===2||p.place===2||p.rank===2);
    const nameOf = p => (p?.name||p?.Name||p?.displayName||'').trim().toLowerCase();

    function computePlacements(){
      const players = (window.game?.players || window.players || []).slice();
      if (!players.length) return new Map();
      const total = players.length;
      const ev = players
        .filter(p => !!(p.evicted || p.state==='evicted' || getEvictWeek(p)!=null))
        .sort((a,b)=>{ const aw=getEvictWeek(a), bw=getEvictWeek(b);
          if (aw!=null&&bw!=null) return aw-bw; if (aw!=null) return -1; if (bw!=null) return 1; return 0; });
      const m = new Map();
      ev.forEach((p,i)=> m.set(nameOf(p), ord(total - i)));
      players.forEach(p=>{ const nm=nameOf(p); if (!nm) return;
        if (isWinner(p)) m.set(nm,'Winner'); else if (isRunnerUp(p)) m.set(nm,'Runner-up'); });
      return m;
    }

    function apply(){
      const map = computePlacements();
      document.querySelectorAll('.top-roster-tile').forEach(tile=>{
        const nm = (tile.querySelector('.top-tile-name')?.textContent||'').trim().toLowerCase();
        const label = map.get(nm);
        if (label){ tile.title = label; tile.dataset.placeLabel = label; }
      });
    }

    const host = document.querySelector('.top-roster-row') || document.getElementById('panel') || document.getElementById('actionCard');
    if (!host){ setTimeout(placementsHover, 400); return; }
    apply();
    const mo = new MutationObserver(apply);
    mo.observe(host, { childList:true, subtree:true, characterData:true });
    window.addEventListener('bb:eviction', apply, { passive:true });
    window.addEventListener('bb:winner', apply, { passive:true });
  }

  // Add Rules button between Settings and Start
  function ensureRulesButton(){
    const topbar = document.querySelector('.topbar');
    if(!topbar) return;
    
    // Check if Rules button already exists
    if(document.getElementById('btnRules')) return;
    
    const settingsBtn = document.getElementById('btnOpenSettings');
    const startBtn = document.getElementById('btnStartQuick');
    if(!settingsBtn || !startBtn) return;
    
    const rulesBtn = document.createElement('button');
    rulesBtn.id = 'btnRules';
    rulesBtn.className = 'btn';
    rulesBtn.textContent = 'üìã Rules';
    
    rulesBtn.onclick = ()=>{
      // Use the new showRulesModal function from rules.js
      if(typeof window.showRulesModal === 'function'){
        window.showRulesModal();
      }
    };
    
    // Insert after Settings button
    settingsBtn.parentNode.insertBefore(rulesBtn, startBtn);
  }

  function init(){ keepSingleSkip(); placementsHover(); ensureRulesButton(); }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init, { once:true });
  else init();
  
  // Expose updateTimerHeader globally so it can be called from ui.hud-and-router.js
  window.updateTimerHeader = updateTimerHeader;
})();
</script>

</body>
</html>
