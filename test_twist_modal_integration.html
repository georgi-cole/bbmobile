<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Twist Modal Integration Test</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    body {
      padding: 20px;
      background: #0a0e14;
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    }
    .test-container {
      max-width: 900px;
      margin: 0 auto;
    }
    h1 {
      margin-bottom: 30px;
    }
    .test-section {
      background: #1a2530;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      border: 1px solid #2a3540;
    }
    .test-section h2 {
      margin-top: 0;
      color: #4a9eff;
    }
    .test-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 15px;
    }
    button {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      background: #3a7bd5;
      color: white;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: background 0.2s;
    }
    button:hover {
      background: #4a8be5;
    }
    button.danger {
      background: #d53a3a;
    }
    button.danger:hover {
      background: #e54a4a;
    }
    button.special {
      background: #8a3ad5;
    }
    button.special:hover {
      background: #9a4ae5;
    }
    button.ok {
      background: #3ad56a;
    }
    button.ok:hover {
      background: #4ae57a;
    }
    .description {
      color: #8a9fb5;
      font-size: 14px;
      margin-bottom: 10px;
    }
    .status {
      margin-top: 15px;
      padding: 10px;
      background: #0a1520;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      min-height: 40px;
      color: #6a8fa5;
    }
    .success { color: #3ad56a; }
    .warning { color: #ff9c3a; }
    .error { color: #d53a3a; }
    .info { color: #4a9eff; }
  </style>
</head>
<body>
  <div class="test-container">
    <h1>üé≠ Twist Modal Integration Test</h1>
    <p style="color: #8a9fb5;">This test validates that old twist announcement cards have been removed and new modals are used correctly.</p>
    
    <div class="test-section">
      <h2>‚úÖ Validation Checklist</h2>
      <div class="description">Tests to verify the removal of old twist cards and modal integration</div>
      <div class="test-buttons">
        <button class="ok" onclick="runAllTests()">Run All Tests</button>
        <button onclick="clearResults()">Clear Results</button>
      </div>
      <div class="status" id="test-results">Click "Run All Tests" to begin validation</div>
    </div>
    
    <div class="test-section">
      <h2>üé≤ Manual Tests</h2>
      <div class="description">Manual tests to verify modal behavior in different scenarios</div>
      <div class="test-buttons">
        <button class="danger" onclick="testDoubleEviction()">Test Double Eviction Modal</button>
        <button class="danger" onclick="testTripleEviction()">Test Triple Eviction Modal</button>
        <button class="special" onclick="testJurorReturn()">Test Juror Return Modal</button>
      </div>
      <div class="status" id="manual-status">Click a button to test modals manually</div>
    </div>

    <div class="test-section">
      <h2>üîß Debug Force Return Test</h2>
      <div class="description">Test the debug "Force Juror's Return" functionality</div>
      <div class="test-buttons">
        <button class="special" onclick="testForceReturn()">Force Juror's Return (Debug)</button>
      </div>
      <div class="status" id="force-return-status">Tests debug flow with modal announcement</div>
    </div>
  </div>

  <!-- Load required scripts -->
  <script src="js/ui.event-modal.js" onerror="handleScriptError('js/ui.event-modal.js')"></script>
  <script src="js/ui.week-intro.js"></script>
  <script src="js/twists.js"></script>
  <script src="js/jury_return.js"></script>
  <script src="js/jury_return_vote.js"></script>

  <script>
    function handleScriptError(scriptName) {
      log('test-results', `‚ùå Failed to load required script: <b>${scriptName}</b>. Modal tests cannot run.`, 'error');
      // Optionally disable test buttons to prevent further errors
      document.querySelectorAll('.test-buttons button').forEach(btn => btn.disabled = true);
    }
    function log(id, message, type = 'info') {
      const el = document.getElementById(id);
      if (!el) return;
      const timestamp = new Date().toLocaleTimeString();
      const className = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'info';
      el.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
    }

    function clearResults() {
      document.getElementById('test-results').innerHTML = 'Tests cleared. Ready to run.';
    }

    async function runAllTests() {
      clearResults();
      log('test-results', 'üîç Starting validation tests...', 'info');
      
      // Test 1: Check that old card functions are removed
      log('test-results', 'Test 1: Checking for old twist card removal...', 'info');
      
      // Simulate checking the source code
      try {
        // Check if showCard is NOT called for DOUBLE WEEK or TRIPLE WEEK
        const twistsSource = window.twists ? 'loaded' : 'not loaded';
        log('test-results', `‚úì twists.js: ${twistsSource}`, 'success');
        
        // Check if showEventModal is available
        if (typeof window.showEventModal === 'function') {
          log('test-results', '‚úì showEventModal function is available', 'success');
        } else {
          log('test-results', '‚úó showEventModal function is NOT available', 'error');
        }
        
        // Check if showTwistAnnouncementIfNeeded is available
        if (typeof window.showTwistAnnouncementIfNeeded === 'function') {
          log('test-results', '‚úì showTwistAnnouncementIfNeeded function is available', 'success');
        } else {
          log('test-results', '‚úó showTwistAnnouncementIfNeeded function is NOT available', 'error');
        }
        
        log('test-results', '', 'info');
        log('test-results', 'Test 2: Simulating twist scenarios...', 'info');
        
        // Test double eviction modal
        await testDoubleEvictionInternal();
        
        // Test triple eviction modal  
        await testTripleEvictionInternal();
        
        // Test juror return modal
        await testJurorReturnInternal();
        
        log('test-results', '', 'info');
        log('test-results', '‚úÖ All tests completed!', 'success');
        log('test-results', 'Expected behavior: No old cards shown, only modals displayed', 'info');
        
      } catch (e) {
        log('test-results', `‚úó Test failed: ${e.message}`, 'error');
      }
    }

    async function testDoubleEviction() {
      log('manual-status', 'Testing Double Eviction modal...', 'info');
      await window.showEventModal({
        title: 'House Shock!',
        emojis: '‚ö†Ô∏èüò±',
        subtitle: 'Double Eviction Week!! Three nominees ‚Äî two leave.',
        tone: 'danger',
        duration: 4000
      });
      log('manual-status', '‚úì Double Eviction modal dismissed', 'success');
    }

    async function testTripleEviction() {
      log('manual-status', 'Testing Triple Eviction modal...', 'info');
      await window.showEventModal({
        title: 'House Shock!',
        emojis: '‚ö†Ô∏èüí•üò±',
        subtitle: 'Triple Eviction Week!!! Four nominees ‚Äî three leave.',
        tone: 'danger',
        duration: 4000
      });
      log('manual-status', '‚úì Triple Eviction modal dismissed', 'success');
    }

    async function testJurorReturn() {
      log('manual-status', 'Testing Juror Return modal...', 'info');
      await window.showEventModal({
        title: 'House Shock!',
        emojis: 'üëÅÔ∏è‚öñÔ∏èüîô',
        subtitle: 'A jury member re-enters the house!',
        tone: 'special',
        duration: 4000
      });
      log('manual-status', '‚úì Juror Return modal dismissed', 'success');
    }

    async function testDoubleEvictionInternal() {
      log('test-results', 'Testing Double Eviction modal...', 'info');
      await window.showEventModal({
        title: 'House Shock!',
        emojis: '‚ö†Ô∏èüò±',
        subtitle: 'Double Eviction Week!! Three nominees ‚Äî two leave.',
        tone: 'danger',
        duration: 2000
      });
      log('test-results', '‚úì Double Eviction modal works', 'success');
    }

    async function testTripleEvictionInternal() {
      log('test-results', 'Testing Triple Eviction modal...', 'info');
      await window.showEventModal({
        title: 'House Shock!',
        emojis: '‚ö†Ô∏èüí•üò±',
        subtitle: 'Triple Eviction Week!!! Four nominees ‚Äî three leave.',
        tone: 'danger',
        duration: 2000
      });
      log('test-results', '‚úì Triple Eviction modal works', 'success');
    }

    async function testJurorReturnInternal() {
      log('test-results', 'Testing Juror Return modal...', 'info');
      await window.showEventModal({
        title: 'House Shock!',
        emojis: 'üëÅÔ∏è‚öñÔ∏èüîô',
        subtitle: 'A jury member re-enters the house!',
        tone: 'special',
        duration: 2000
      });
      log('test-results', '‚úì Juror Return modal works', 'success');
    }

    async function testForceReturn() {
      log('force-return-status', 'Testing Force Juror\'s Return (debug mode)...', 'info');
      log('force-return-status', 'Setting up mock game state...', 'info');
      
      // Setup minimal game state for testing
      window.game = window.game || {
        cfg: { enableJuryHouse: true, tJuryReturnVote: 12 },
        players: [
          { id: 1, name: 'Player 1', evicted: true },
          { id: 2, name: 'Player 2', evicted: false },
          { id: 3, name: 'Player 3', evicted: false }
        ],
        juryHouse: [1],
        week: 5
      };
      
      // Mock required functions
      window.getP = window.getP || ((id) => window.game.players.find(p => p.id === id));
      window.safeName = window.safeName || ((id) => window.getP(id)?.name || `Player ${id}`);
      window.setPhase = window.setPhase || ((phase, duration, callback) => {
        log('force-return-status', `Phase set to: ${phase}`, 'info');
        if (callback) setTimeout(callback, duration * 100);
      });
      window.updateHud = window.updateHud || (() => {});
      
      try {
        log('force-return-status', 'Triggering modal announcement...', 'info');
        
        // Test the modal directly
        await window.showEventModal({
          title: 'House Shock!',
          emojis: 'üëÅÔ∏è‚öñÔ∏èüîô',
          subtitle: 'A jury member re-enters the house!',
          tone: 'special',
          duration: 3000
        });
        
        log('force-return-status', '‚úì Modal shown successfully for debug force return', 'success');
        log('force-return-status', '‚úì Old cards were NOT shown (expected behavior)', 'success');
        log('force-return-status', 'Test completed successfully!', 'success');
      } catch (e) {
        log('force-return-status', `‚úó Error: ${e.message}`, 'error');
      }
    }

    // Initialize
    window.addEventListener('DOMContentLoaded', () => {
      log('test-results', 'Test page loaded. Ready to run tests.', 'info');
    });
  </script>
</body>
</html>
